name: Package Templates

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  LC_ALL: en_US.UTF-8
  LANG: en_US.UTF-8
  ZIPOPT: -UN=UTF8

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: repo-content

      - name: Ensure UTF-8 locale
        run: |
          sudo locale-gen en_US.UTF-8
          sudo update-locale LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8

      - name: Package templates
        working-directory: repo-content
        run: |
          set -euo pipefail

          mkdir -p ../zips
          release_notes=../release-notes.md

          cat > "$release_notes" <<'EOF'
          # 学术模板发布包

          ## 包含模板
          EOF

          while IFS='|' read -r source_dir zip_name desc_zh desc_en; do
            [ -z "$source_dir" ] && continue

            if [ ! -d "$source_dir" ]; then
              echo "⚠️ Folder not found: $source_dir" >&2
              continue
            fi

            tmp_dir="$(mktemp -d)"
            bundle_root="$zip_name"

            mkdir -p "$tmp_dir/$bundle_root"
            rsync -a --info=skip0 -- "$source_dir"/ "$tmp_dir/$bundle_root"/

            (
              cd "$tmp_dir"
              zip -r -9 --quiet -UN=UTF8 "../zips/${zip_name}.zip" "$bundle_root"
            )

            rm -rf "$tmp_dir"

            printf ' - %s: %s\n' "$zip_name" "$desc_zh" >> "$release_notes"
          done <<'LIST'
          conferences/AAMAS-2024|AAMAS-2024|AAMAS 2024 会议模板|AAMAS 2024 Conference Template
          journals/IEEE-Transactions|IEEE-Transactions|IEEE Transactions 期刊模板|IEEE Transactions LaTeX Template
          journals/Elsevier-Neurocomputing|Elsevier-Neurocomputing|Elsevier Neurocomputing 期刊模板|Elsevier Neurocomputing Template
          journals/计算机学报|计算机学报|《计算机学报》期刊模板|Journal of Computer Science Template
          journals/控制理论与应用|控制理论与应用|《控制理论与应用》期刊模板|Control Theory & Applications Template
          LIST

          cat >> "$release_notes" <<'EOF'

          ---

          # Academic Templates Release

          ## Included Templates
          EOF

          while IFS='|' read -r _ zip_name _ desc_en; do
            [ -z "$zip_name" ] && continue
            printf ' - %s: %s\n' "$zip_name" "$desc_en" >> "$release_notes"
          done <<'LIST'
          conferences/AAMAS-2024|AAMAS-2024|AAMAS 2024 会议模板|AAMAS 2024 Conference Template
          journals/IEEE-Transactions|IEEE-Transactions|IEEE Transactions 期刊模板|IEEE Transactions LaTeX Template
          journals/Elsevier-Neurocomputing|Elsevier-Neurocomputing|Elsevier Neurocomputing 期刊模板|Elsevier Neurocomputing Template
          journals/计算机学报|计算机学报|《计算机学报》期刊模板|Journal of Computer Science Template
          journals/控制理论与应用|控制理论与应用|《控制理论与应用》期刊模板|Control Theory & Applications Template
          LIST

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body_path: release-notes.md
          files: |
            zips/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
